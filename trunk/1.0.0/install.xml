<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
<header>
	<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

	<title lang="en">Topic Multi-Moderation</title>
	
	<description lang="en">This MOD adds a quick and easy way to perform multiple moderation tasks with one click. Configurable via the ACP.</description>

	<author-notes lang="en">Version 0.2.0 is a complete rewrite of the MOD, and is not backwards compatible to my knowledge. You will need to COMPLETELY uninstall the old version, and install the new one fresh. That is a major reason for the following warning:
	This MOD is currently in the BETA stage and should NOT be used in a live environment. You are, however, welcome to use it on a test board.
	If you would like to make a donation for my work done on this MOD as well as other MODs, you may do so by going to the demo/test board (http://www.phpbbdevelopers.net/) and clicking the Donate button in the header. All donations are voluntary but appreciated.</author-notes>

	<author-group>
		<author>
			<username>imkingdavid</username>
			<realname>David King</realname>
			<homepage>http://www.phpbbdevelopers.net</homepage>
			<email>imkingdavid@gmail.com</email>
		</author>
	</author-group>

	<mod-version>0.2.0</mod-version>

	<installation>
		<level>intermediate</level>
		<time>300</time>
		<target-version>3.0.7-PL1</target-version>
	</installation>
	<history>
		<entry>
			<date>2010-05-1</date>
			<rev-version>0.2.0</rev-version>
			<changelog lang="en">
				<change>[Change] Complete code rewrite</change>
				<change>[Feature] Tokens in prefix (i.e. {USERNAME} and {DATE})</change>
				<change>[Feature] Add multiple prefixes to topic</change>
				<change>[Feature] Added more flexibility for better control per prefix and multi-mod</change>
				<change>[Note] Not backwards compatible.</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-12-16</date>
			<rev-version>0.1.4 BETA</rev-version>
			<changelog lang="en">
				<change>[Fix] bug in ACP prefixes edit module</change>
				<change>[Fix] color swatch in ACP prefixes module</change>
				<change>[Fix] for bug caused by another MOD (topic_status cannot be NULL)</change>
				<change>[Note] never released</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-09-13</date>
			<rev-version>0.1.3 BETA</rev-version>
			<changelog lang="en">
				<change>[Change]Changed the version numbering from 1.0.0 BETA # to 0.1.# BETA.</change>
				<change>[Fix] errors generated in posting.php</change>
				<change>[Fix] errors generated in viewtopic.php (thanks tbxn)</change>
				<change>[Fix] made module() function in info/acp_tmm.php a public function (thanks tbxn)</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-09-01</date>
			<rev-version>0.1.2 BETA</rev-version>
			<changelog lang="en">
				<change>[Change] Changed permission settings (now there are separte admin permissions, as well as separate forum-specific permissions for multi-mods and prefixes).</change>
				<change>[Fix] Fixed various bugs in posting.php, posting_editor.html</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-09-01</date>
			<rev-version>0.1.1 BETA</rev-version>
			<changelog lang="en">
				<change>[Fix] Fixed ANOTHER bug in prefix dropdown menu on posting</change>
				<change>[Fix] Fixed various template bugs</change>
				<change>[Fix] Fixed various viewforum, posting, and viewtopic bugs</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-08-31</date>
			<rev-version>0.1.0 BETA</rev-version>
			<changelog lang="en">
				<change>[Fix] Fixed bug in prefix dropdown menu on posting</change>
				<change>[Feature] Added copy ability for multi-mods</change>
				<change>[Feature] Added UMIL automated install/uninstall/update file: tmm_install.php</change>
				<change>[Feature] Verified AutoMOD compatibility</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-08-25</date>
			<rev-version>0.0.3 ALPHA</rev-version>
			<changelog lang="en">
				<change>[Change] Added support for separate prefix use on posting.php (new thread and edit first post screen)</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-08-23</date>
			<rev-version>0.0.2 ALPHA</rev-version>
			<changelog lang="en">
				<change>[Fix] Made a few fixes to the install.xml file</change>
				<change>[Change] Changed database tables (added default value)</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-08-23</date>
			<rev-version>0.0.1 ALPHA</rev-version>
			<changelog lang="en">
				<change>Completed bulk of the coding</change>
				<change>Released first alpha version</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-08-15</date>
			<rev-version>0.0.0 DEV</rev-version>
			<changelog lang="en">
				<change>Begun development</change>
			</changelog>
		</entry>
	</history>
</header>

<action-group>
	<copy>
		<file from="root/*.*" to="*.*" />
	</copy>
	<open src="mcp.php">
		<edit>
			<find><![CDATA[if (!$post_id)
{
	$module->set_display('main', 'post_details', false);
	$module->set_display('warn', 'warn_post', false);
}]]></find>
			<action type="before-add"><![CDATA[$tmm_id = request_var('multimod', 0);
if($tmm_id == 0)
{
	$module->set_display('tmm', 'index', false);
}]]></action>
		</edit>
	</open>
	<open src="posting.php">
		<edit>
			<find><![CDATA[$refresh	= (isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['full_editor']) || isset($_POST['cancel_unglobalise']) || $save || $load) ? true : false;]]></find>
			<inline-edit>
				<inline-find><![CDATA[isset($_POST['cancel_unglobalise'])]]></inline-find>
				<inline-action type="after-add"><![CDATA[ || isset($_POST['prefix_add']) || isset($_POST['prefix_remove']) || isset($_POST['prefix_clear'])]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[$error = $post_data = array();
$current_time = time();]]></find>
			<action type="after-add"><![CDATA[
//! Begin TMM
include($phpbb_root_path . 'includes/functions_tmm.' . $phpEx);
include($phpbb_root_path . 'includes/tmm_constants.' . $phpEx);
$tmm = new tmm;
$user->add_lang('mods/tmm');
$prefix_id	= request_var('prefix_dropdown', 0);
$prefix_instance_id = request_var('prefix', array(0));
$prefix_add = (isset($_POST['prefix_add'])) ? 1 : 0;
$prefix_remove = (isset($_POST['prefix_remove'])) ? 1 : 0;
$prefix_clear = (isset($_POST['prefix_clear'])) ? 1 : 0;
//! End TMM]]></action>
		</edit>
		<edit>
			<find><![CDATA[// Load draft overview
if ($load && ($mode == 'reply' || $mode == 'quote' || $mode == 'post') && $post_data['drafts'])
{
	load_drafts($topic_id, $forum_id);
}]]></find>
		<action type="after-add"><![CDATA[
//! Begin TMM
if($mode == 'post')
{
	$prefix_cache = request_var('prefix_temp_cache', '');
	
	if($prefix_add)
	{
		$prefix_cache .= $prefix_id . ',';
	}
	elseif($prefix_remove)
	{
		foreach($prefix_instance_id AS $instance)
		{
			$prefix_cache = preg_replace('/' . $instance . '/', '', $prefix_cache, 1);
		}
	}
	elseif($prefix_clear)
	{
		$prefix_cache = '';
	}
	else
	{
		//Nothing.
	}
	// Get list of applied prefixes
	$prefix_cache_array = explode(',', $prefix_cache);
	$prefixes = $tmm->load_topic_prefixes($topic_id, 'array', $prefix_cache_array);
	$literal_prefixes = $tmm->load_topic_prefixes($topic_id, 'array', $prefix_cache_array, 'prefixes');
	$prefix_select = $tmm->get_prefix_dropdown($forum_id, 'single', 0, $literal_prefixes);
	$prefixed = '';
	if(is_array($prefixes))
	{
		foreach($prefixes AS $prefix)
		{
			$prefixed .= (!empty($prefix)) ? $tmm->parse_prefix($prefix) . ' <input type="checkbox" name="prefix[]" value="' . $prefix . '" /><br />' : '';
		}
	}
	$prefixed = (empty($prefixed)) ? false : $prefixed;
	$template->assign_vars(array(
		'PREFIX_SELECT'		=> $prefix_select,
		'ON_NEW_POST'		=> true,
		'APPLIED_PREFIXES'	=> $prefixed,
		'PREFIX_TEMP_CACHE'	=> $prefix_cache,
	));
}
if($mode == 'edit' && ($post_data['topic_first_post_id'] == $post_id))
{	
	if($prefix_add)
	{
		$apply = $tmm->apply_prefix($prefix_id, $topic_id);
	}
	elseif($prefix_remove)
	{
		foreach($prefix_instance_id AS $instance)
		{
			$remove = $tmm->remove_topic_prefix($instance, $topic_id);
		}
	}
	elseif($prefix_clear)
	{
		$remove_all = $tmm->remove_topic_prefixes($topic_id);
	}
	else
	{
		//Nothing.
	}
	// Get list of applied prefixes
	$prefixes = $tmm->load_topic_prefixes($topic_id, 'array');
	$literal_prefixes = $tmm->load_topic_prefixes($topic_id, 'array', 'sql', 'prefixes');
	$prefix_select = $tmm->get_prefix_dropdown($forum_id, 'single', 0, $literal_prefixes);
	$prefixed = '';
	if(!empty($prefixes))
	{
		foreach($prefixes AS $prefix)
		{
			$prefixed .= $tmm->parse_prefix_instance($prefix) . ' <input type="checkbox" name="prefix[]" value="' . $prefix . '" /><br />';
		}
	}
	$prefixed = (empty($prefixed)) ? false : $prefixed;
	$template->assign_vars(array(
		'PREFIX_SELECT'		=> $prefix_select,
		'ON_EDIT_POST'		=> true,
		'APPLIED_PREFIXES'	=> $prefixed,
	));	
}
$template->assign_var('TOPIC_PREFIX', $tmm->load_topic_prefixes($topic_id));
//! End TMM]]></action>
		</edit>
		<edit>
			<find><![CDATA[$redirect_url = submit_post($mode, $post_data['post_subject'], $post_data['username'], $post_data['topic_type'], $poll, $data, $update_message, ($update_message || $update_subject) ? true : false);]]></find>
			<action type="after-add"><![CDATA[//! Begin TMM
			if($mode == 'post')
			{
				if(is_array($prefixes))
				{
					foreach($prefixes AS $prefix)
					{
						$redir_url_split = explode('t=', $redirect_url);
						$topic_id = $redir_url_split[1];
						$tmm->apply_prefix($prefix, $topic_id);
					}
				}
			}
			//! End TMM]]></action>
		</edit>
	</open>
	<open src="viewforum.php">
		<edit>
			<find><![CDATA[// Start session
$user->session_begin();
$auth->acl($user->data);]]></find>
			<action type="after-add"><![CDATA[
//! Begin TMM
include($phpbb_root_path . 'includes/functions_tmm.' . $phpEx);
include($phpbb_root_path . 'includes/tmm_constants.' . $phpEx);
$tmm = new tmm;
$user->add_lang('mods/tmm');
//! End TMM]]></action>
		</edit>
		<edit>	
			<find><![CDATA['TOPIC_TYPE'		=> $topic_type,]]></find>
			<action type="after-add"><![CDATA[			//! Begin TMM
			'TOPIC_PREFIX'		=> $tmm->load_topic_prefixes($row['topic_id']),
			//! End TMM]]></action>
		</edit>
	</open>
	<open src="viewtopic.php">
		<edit>
			<find><![CDATA[// Start session management
$user->session_begin();
$auth->acl($user->data);]]></find>
			<action type="after-add"><![CDATA[
//! Begin TMM
include($phpbb_root_path . 'includes/functions_tmm.' . $phpEx);
include($phpbb_root_path . 'includes/tmm_constants.' . $phpEx);
$tmm = new tmm;
$user->add_lang('mods/tmm');
//! End TMM]]></action>
		</edit>
		<edit>
			<find><![CDATA[	'TOPIC_POSTER'	=> $topic_data['topic_poster'],]]></find>
			<action type="after-add"><![CDATA[//! Begin TMM
	'TOPIC_PREFIX'	=> $tmm->load_topic_prefixes($topic_data['topic_id']),
	'TMM_SELECT'	=> $tmm->get_tmm_dropdown($topic_data['forum_id']),
	'S_TMM_ACTION' 	=> append_sid("{$phpbb_root_path}mcp.$phpEx", "i=tmm&amp;f=$forum_id&amp;t=$topic_id&amp;start=$start&amp;multimod=1&amp;redirect=" . urlencode(str_replace('&amp;', '&', $viewtopic_url)), true, $user->session_id),
	//! End TMM]]></action>
		</edit>
	</open>
	
	<open src="styles/prosilver/template/posting_editor.html">
		<edit>
			<find><![CDATA[<!-- IF CAPTCHA_TEMPLATE and S_CONFIRM_CODE -->
		<!-- DEFINE $CAPTCHA_TAB_INDEX = 3 -->
		<!-- INCLUDE {CAPTCHA_TEMPLATE} -->
	<!-- ENDIF -->
	<!-- ENDIF -->]]></find>
			<action type="after-add"><![CDATA[
    
    <!-- INCLUDE tmm_posting_body.html -->]]></action>
		</edit>
	</open>
	
	<open src="styles/prosilver/template/posting_layout.html">
		<edit>	
			<find><![CDATA[<h2><a href="{U_VIEW_TOPIC}">{TOPIC_TITLE}</a></h2>]]></find>
			<action type="replace-with"><![CDATA[<h2>{TOPIC_PREFIX}<a href="{U_VIEW_TOPIC}">{TOPIC_TITLE}</a></h2>]]></action>
		</edit>
	</open>
		
	<open src="styles/prosilver/template/viewforum_body.html">
		<edit>	
			<find><![CDATA[<dt<!-- IF topicrow.TOPIC_ICON_IMG and S_TOPIC_ICONS --> style="background-image: url({T_ICONS_PATH}{topicrow.TOPIC_ICON_IMG}); background-repeat: no-repeat;"<!-- ENDIF --> title="{topicrow.TOPIC_FOLDER_IMG_ALT}"><!-- IF topicrow.S_UNREAD_TOPIC --><a href="{topicrow.U_NEWEST_POST}">{NEWEST_POST_IMG}</a> <!-- ENDIF --><a href="{topicrow.U_VIEW_TOPIC}" class="topictitle">{topicrow.TOPIC_TITLE}</a>]]></find>
			<action type="replace-with"><![CDATA[<dt<!-- IF topicrow.TOPIC_ICON_IMG and S_TOPIC_ICONS --> style="background-image: url({T_ICONS_PATH}{topicrow.TOPIC_ICON_IMG}); background-repeat: no-repeat;"<!-- ENDIF --> title="{topicrow.TOPIC_FOLDER_IMG_ALT}"><!-- IF topicrow.S_UNREAD_TOPIC --><a href="{topicrow.U_NEWEST_POST}">{NEWEST_POST_IMG}</a> <!-- ENDIF -->{topicrow.TOPIC_PREFIX}<a href="{topicrow.U_VIEW_TOPIC}" class="topictitle">{topicrow.TOPIC_TITLE}</a>]]></action>
		</edit>
	</open>
	
	<open src="styles/prosilver/template/viewtopic_body.html">
		<edit>	
			<find><![CDATA[<h2><a href="{U_VIEW_TOPIC}">{TOPIC_TITLE}</a></h2>]]></find>
			<action type="replace-with"><![CDATA[<h2>{TOPIC_PREFIX}<a href="{U_VIEW_TOPIC}">{TOPIC_TITLE}</a></h2>]]></action>
		</edit>
		<edit>	
			<find><![CDATA[<!-- IF S_TOPIC_MOD -->
	<form method="post" action="{S_MOD_ACTION}">
	<fieldset class="quickmod">
		<label for="quick-mod-select">{L_QUICK_MOD}:</label> {S_TOPIC_MOD} <input type="submit" value="{L_GO}" class="button2" />
		{S_FORM_TOKEN}
	</fieldset>
	</form>
<!-- ENDIF -->]]></find>
			<action type="replace-with"><![CDATA[<!-- IF TMM_SELECT -->
	<br clear="right" />
	<form method="post" action="{S_TMM_ACTION}">
    <fieldset class="quickmod">
    	<label for="tmm-mod-select">{L_MULTI_MODS}:</label> {TMM_SELECT} <input type="submit" value="{L_GO}" class="button2" />
    </fieldset>
    </form>
<!-- ENDIF -->]]></action>
		</edit>
	</open>
	<php-installer>tmm_install.php</php-installer>
	<diy-instructions lang="en"><![CDATA[
	1) Make sure you have copied all files from root/*.* to the {phpBB root directory}/*.*, and that all file edits have been successfully performed. *If using AutoMOD, these should all be done instantly, but it's still always good to double check.!
	2) Navigate your browser to {phpBB root directory}/tmm_install.php - Once that runs, you are done. You may now remove that file and go to ACP, Posting and see two new modules. Enjoy! *Note that this file can also be used to uninstall, should you run into trouble. Although realize that this does not undo file edits, so you will need to use AutoMOD for that. In later versions, you will also be able to update using this file (and use AutoMOD for file edit updates).
	3)If you encounter any issues with the MOD, you are welcome to contact me at imkingdavid@gmail.com or go the the development topic at phpBB.com and let me know so that I can fix them!.
	
	Development of MODs occurs during my free time. While I enjoy coding, I have little incentive to commit a lot of time to it. However, if I recieve donations I am more willing to do more work to compensate. If you feel willing to donate, please follow the instructions at the test board (http://www.phpbbdevelopers.net/). Thanks!]]>
	</diy-instructions>
</action-group>
</mod>